---
import { getCollection, getEntry, render } from 'astro:content';
import { type Lang, t, languages } from '../../../i18n';
import { Image } from 'astro:assets';
import Layout from '@layouts/Layout.astro';

interface Props {
  lang: Lang;
  id: string;
}

export async function getStaticPaths() {
  const entries = await getCollection('news');

  return languages.flatMap((lang) =>
    entries.map((entry) => ({
      params: { lang, slug: entry.data.slug ?? entry.id },
      props: { lang, id: entry.id }
    }))
  );
}

const { lang: routeLang } = Astro.params;
const { lang, id } = Astro.props as Props;

if (!routeLang || !languages.includes(routeLang as Lang)) {
  return Astro.redirect('/404');
}

const entry = await getEntry('news', id);
if (!entry) return Astro.redirect(`/${lang}/404`);

const { title, shortDescription, publishDate, image } = entry.data;

const date = publishDate
  ? new Date(publishDate).toLocaleDateString(lang === 'pl' ? 'pl-PL' : 'en-US', {
      year: 'numeric',
      month: 'long',
      day: '2-digit'
    })
  : null;

// New-style render helper
const { Content } = await render(entry);
---

<Layout lang={lang}>
  <main class="mx-auto w-full max-w-3xl px-4 py-10">
    <article class="space-y-6">
      <header class="space-y-3">
        {
          date && (
            <time
              datetime={new Date(publishDate).toISOString()}
              class="inline-flex rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700
                 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200"
            >
              {date}
            </time>
          )
        }

        <h1 class="text-3xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">
          {title}
        </h1>

        {shortDescription && <p class="text-base leading-7 text-slate-600 dark:text-slate-300">{shortDescription}</p>}
      </header>

      {
        image && (
          <Image
            src={image.src}
            alt={image.alt}
            class="aspect-[16/9] w-full rounded-2xl border border-slate-200 object-cover dark:border-slate-800"
            loading="lazy"
          />
        )
      }

      <div class="prose prose-slate max-w-none dark:prose-invert">
        <Content />
      </div>

      <footer class="pt-6">
        <a
          href={`/${lang}/news`}
          class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium text-slate-900 transition
               hover:bg-slate-100 dark:text-slate-100 dark:hover:bg-slate-900"
        >
          ‚Üê {t(lang, 'newsBackToList') ?? 'Back to news'}
        </a>
      </footer>
    </article>
  </main>
</Layout>
